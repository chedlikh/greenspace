pipeline {
    agent any

    tools {
        maven 'M2_HOME'
    }

    environment {
        // Nexus variables
        NEXUS_VERSION = "nexus3"
        NEXUS_PROTOCOL = "http"
        NEXUS_URL = "192.168.0.187:8081"
        NEXUS_REPOSITORY = "maven-releases"
        NEXUS_CREDENTIAL_ID = "NEXUS_CRED"
        ARTIFACT_VERSION = "${BUILD_NUMBER}"
        
        // Docker variables
        DOCKER_CREDENTIALS_ID = "docker-hub-creds"
        DOCKER_IMAGE = "chdoula1/greenspace"
        DOCKER_COMPOSE_FILE = "docker-compose.yml"
        DOCKER_TAG = "v1.0.0-${BUILD_NUMBER}"
        EMAIL_RECIPIENT = 'chdouuulaa@gmail.com'
        EMAIL_SUBJECT = 'Jenkins Build Notification'
        STATIC_IP = "192.168.0.187"
    }

    stages {
        // [Previous stages remain exactly the same until Deploy stage]

        stage('Deploy with Docker Compose') {
            steps {
                script {
                    dir('app') {
                        // Build frontend with the static IP
                        sh """
                            cd ../greenspace && \
                            docker build \
                                --build-arg API_BASE_URL=http://${STATIC_IP}:8089 \
                                -t ${DOCKER_IMAGE}-frontend:${DOCKER_TAG} \
                                -f Dockerfile.frontend .
                        """
                        
                        // Substitute environment variables in compose file
                        sh """
                            envsubst < ${DOCKER_COMPOSE_FILE} > docker-compose-processed.yml
                            docker compose -f docker-compose-processed.yml up -d --build --force-recreate
                        """
                    }
                }
            }
        }
    }
    // [Post section remains the same]
}
